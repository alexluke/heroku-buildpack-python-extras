#!/usr/bin/env bash

RUBY_DIR="$BUILD_DIR/.heroku/ruby"
VENDOR_DIR="$RUBY_DIR/bundle/ruby/1.9.1"
RUBY_VENDOR_URL="https://s3.amazonaws.com/heroku-buildpack-ruby"
BUNDLER_VERSION="1.2.1"
BUNDLER_GEM_PATH="bundler-$BUNDLER_VERSION"

# Make our sandbox dir
mkdir -p $VENDOR_DIR

# Install Bundler
CURRENT_DIR=$(pwd)
cd $VENDOR_DIR
curl "$RUBY_VENDOR_URL/$BUNDLER_GEM_PATH.tgz" -s -o - | tar xzf -
cd $CURRENT_DIR

# Setup environment
export PATH="$RUBY_DIR/bin:$VENDOR_DIR/bin:$PATH"
export GEM_HOME=$VENDOR_DIR
export GEM_PATH=$VENDOR_DIR

# Run Bundler to install dependencies
puts-step "Installing gem dependencies using bundler version $BUNDLER_VERSION"
BUNDLE_WITHOUT=${BUNDLE_WITHOUT:-"development:test"}
bundle install --without $BUNDLE_WITHOUT --path $RUBY_DIR/bundle --binstubs $RUBY_DIR/bin --deployment | indent

# Setup for a Ruby specific profile.d
RUBY_PROFILE_PATH="$BUILD_DIR/.profile.d/ruby.sh"
mkdir -p $(dirname $RUBY_PROFILE_PATH)

# Usage: $ set-rb-env-overide key value
function set-rb-env-overide () {
  echo "export $1=$2" >> $RUBY_PROFILE_PATH
}

# Usage: $ set-rb-env-default key value
function set-rb-env-default () {
  echo "export $1=\${$1:-$2}" >> $RUBY_PROFILE_PATH
}

# Setup .profile.d env
set-rb-env-overide PATH $PATH
set-rb-env-default GEM_HOME $GEM_HOME
set-rb-env-default GEM_PATH $GEM_PATH
